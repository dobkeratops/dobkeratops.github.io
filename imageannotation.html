<html>
<body>
<style>body{overflow:hidden; width:100%;height:100%}</style>
<div>
tool:
<button id="point">(o)point</button>
<button id="line">(l)line</button>
<button id="rect">(r)rectangle</button>
<button id="poly">(p)polygon</button>
<button id="edit">(e)edit</button>
<input id="currentLabel" value="object">current label</button>
<input type="checkbox" id="showLabels" checked>showLabels</input>
<input type="checkbox" id="showAllPolys" checked>showAllPolys</input>
<button id="newImage">new image</button>
<button id="load">load</button>
<button id="save">save</button>
<button id="help">help</button>

<div id="presetArea">
<canvas id="editor" width="1920" height="1080">
</canvas>
<script>

document.getElementById("help").onclick=function(){alert(
"hotkeys:\no\tpoint tool\nl\tline tool\nr\trect tool\np\tpoint tool\ne\tedit tool\n[ ]\ttoggle preset labels;\nenter\trename object;\n< >\tswitch current poly\n"+
"save\tdownloads current annotations as JSON\n"+
"drag-drop JSON file to load image & annotations\n");
};
document.getElementById("newImage").onclick=function(){
/* confirm overwrite.. shouldn't need when web based.
  if (g_polys.length) {
    if (!confirm("changing URL will lose current polys:"+g_polys.length)){
      return;
    }
  }
*/
  url=prompt("enter image URL");
  if (!url){return;}
  
  LoadImage(url);
  g_polys=[];
  repaint();
}

editor=document.getElementById("editor");
var g_presetLabels=["object","person","vehicle","plant","animal","tree","building","machine","head","kerb","road marking","barrier","lamppost","bin","window","door","object1","object2","object3"];

labelEdit=document.getElementById("currentLabel");
//? only got dropdown, not combo boxes?
//throw the presets into the dropdown..
//for (i=0; i<g_presetLabels; i++) {
//
//}

var g_defaultColors={
   "person":"#1000f0", "people":"#1000f0", 
   "man":"#0000ff",    "woman":"#2000f0",
   "vehicle":"#ff0000", "car":"#ff0000",
   "bus":"#ff0000",     "truck":"#ff0000",
   "SUV":"#ff0000",     "suv":"#ff0000",
   "plant":"#00ff00",   "bush":"#00ff00",
   "vegetation":"#00ff00", "grass":"#00ff00",
   "tree":"#00ff00",
   "animal":"#800080",   "dog":"#800080",
   "horse":"#800080",    "cat":"#800080",
   "cow":"#800080",      "sheep":"#800080",
   "livestock":"#800080","cattle":"#800080",
   "building":"#c04000", "house":"#c04000",
   "barrier":"#c04000",
   "machine":"#008080",
};
function AddPoly(poly){ clr=g_defaultColors[poly.name]; if (clr){poly.color=clr;} else {poly.color="#008000"}; g_polys.push(poly); g_currentPoly=g_polys.length-1;}
var g_currentPoly=-1;
var g_drawingPoly=[];
var g_presetLabelIndex=0;
var g_showLabelNames=true;
var g_showAllPolys=true;
var g_currentPolyOutline="#ffffff";

var g_mousepos={};
var g_dragstart={};
var g_drawfeedback=null;
var g_polys=[];
var g_tool;
var g_img = new window.Image();
var g_mouseDelta={};
var g_showVertices=true;
var g_labelColor="white"
// default image to load..
g_img.src="https://upload.wikimedia.org/wikipedia/commons/thumb/5/56/Queen_Street_NOTL_1.jpg/1920px-Queen_Street_NOTL_1.jpg";
g_img.ready=false;

g_img.onload=function(){
  console.log("image.onload");
  g_scaled_w = 1024; g_scaled_h= (g_scaled_w * g_img.height)/g_img.width;
  this.ready=true;
  repaint();  
}

function LoadImage(url){
  //TODO: means of using pre-specified scaled sizes.
  g_img.ready=false;
  g_img.src=url;
  console.log("image.src="+url);
}

urlgadget=document.getElementById("imageurl");
if (urlgadget){
  urlgadget.oninput=function(){
    LoadImage(document.getElementById("imageurl").value);
    g_polys=[];
  } 
}

var g_width = editor.width;
var g_height = editor.height;
var g_scaled_w = 1024; g_scaled_h= (g_scaled_w * g_img.height)/g_img.width;

function lerp(a,b,f){
   return (b-a)*f+a;
}
function polyDiagonalHexFromRect(rc) {
  var width = Math.abs(rc.end.x-rc.start.x);
  var height = Math.abs(rc.end.y-rc.start.y);
  x0 = rc.start.x;
  y0 = rc.start.y;
  x1 = rc.end.x;
  y1 = rc.end.y;
  fx=0.75; fy=0.125; // trim a little from the diagonal
  fyy=0.035;

  if (width > height) { // wider than tall - split horiz
     return {
      points:[
        {x:x0, y:lerp(y0,y1,fyy)},
        {x:lerp(x0,x1,fx),       y:y0},
        {x:x1,   y:lerp(y0,y1,fy)},
        {x:x1,   y:lerp(y1,y0,fyy)},
        {x:lerp(x1,x0,fx),       y:y1},
        {x:x0,   y:lerp(y1,y0,fy)}
      ],
      name:rc.name
     };
  } else {
     midy=(rc.start.y+rc.end.y)*0.5;
     return {
      points:[
        {x:lerp(x0,x1,fyy),     y:y0},
        {x:lerp(x1,x0,fy),     y:y0},
        {x:x1,     y:lerp(y0,y1,fy)},
        {x:lerp(x1,x0,fyy),     y:y1},
        {x:lerp(x0,x1,fy),  y:y1},
        {x:x0,      y:lerp(y1,y0,fy)}
      ],
      name:rc.name
    };
  }
}

function polyFromRect(rc) {
  return {
    points:[
      {x:rc.start.x, y:rc.start.y},
      {x:rc.end.x,   y:rc.start.y},
      {x:rc.end.x,   y:rc.end.y},
      {x:rc.start.x, y:rc.end.y}
    ],
    name:rc.name
  };
}

function polyOctFromRect(rc) {
  x0 = rc.start.x;
  y0 = rc.start.y;
  x1 = rc.end.x;
  y1 = rc.end.y;
  t=0.1; // trim a little from the corners

  return {
    points:[
      {x:lerp(x0,x1,t),  y:y0},
      {x:lerp(x1,x0,t),  y:y0},
      {x:x1,  y:lerp(y0,y1,t)},
      {x:x1,  y:lerp(y1,y0,t)},
      {x:lerp(x1,x0,t),  y:y1},
      {x:lerp(x0,x1,t),  y:y1},
      {x:x0,  y:lerp(y1,y0,t)},
      {x:x0,  y:lerp(y0,y1,t)},
    ],
    name:rc.name
  };
}

function averagePoint(a,b){
  return {x:(a.x+b.x)/2, y:(a.y+b.y)/2}
}
function distSquared2d(a,b){
   dx=b.x-a.x; dy=b.y-a.y; return dx*dx+dy*dy;
}
g_snapRadius=5;

// any polygon points that are colinear with prev/next deemed extraneous - remove
function trimPolyPoints(poly) {
  newpoints=[];
  if (poly.points.length<3) {return;}
  num=poly.points.length;
  for (i=0; i<num; i++) {
     iprev=(i+num-1)%num;
     inext=(i+1)%num;
     pt=poly.points[i];
     midpoint=averagePoint(poly.points[iprev],poly.points[inext]);
     if (distSquared2d(midpoint,pt)>g_snapRadius*g_snapRadius){
       newpoints.push(pt);
     }
  }
  if (newpoints.length!=poly.points.length){
    poly.points=newpoints;
  }
}

function polyFromLine(v0,v1,name){
  return{
    points:[v0,v1],
    name:name
  }
}
function polyFromPoint(v0,name){
  return{
    points:[v0],
    name:name
  }
}
function fillCircle(context, x,y,r) {
  context.beginPath();
  context.arc(x, y, r, 0, 2*Math.PI);
  context.fill();
}

function drawRectOutline(context,start,end){
  context.beginPath();
  context.moveTo(start.x,start.y);
  context.lineTo(end.x,start.y);
  context.lineTo(end.x,end.y);
  context.lineTo(start.x,end.y);
  context.lineTo(start.x,start.y);
  context.stroke();
}
function dragFeedbackCrosshairFull(context){
  drawCrosshairFull(context,g_mousepos);
}
function drawPointSnapCrosshair(ctx,cursorPos){
  vt=pickPointAt(cursorPos);
  drawCrosshair(ctx,vt?vt:cursorPos,g_snapRadius*2);
  if (vt) { fillCircle(ctx,vt.x,vt.y,g_snapRadius);}
}

function dragFeedbackCrosshair(context){
  drawPointSnapCrosshair(context,g_mousepos,g_snapRadius);
}

function dragFeedbackRect(context){
    context.globalAlpha=0.5;
    context.fillStyle = "red";
    context.beginPath();
    context.moveTo(g_dragstart.x,g_dragstart.y);
    context.lineTo(g_mousepos.x,g_dragstart.y);
    context.lineTo(g_mousepos.x,g_mousepos.y);
    context.lineTo(g_dragstart.x,g_mousepos.y);
    context.closePath();
    context.fill();
}

function getSnappedRefPoint(cursor){
   vt=pickPointAt(cursor);
   return vt?vt:cursor;
}

function dragFeedbackLine(context){
    context.globalAlpha=0.75;
    context.strokeStyle = "red";
    context.beginPath();
    context.moveTo(g_dragstart.x,g_dragstart.y);
    endpoint=getSnappedRefPoint(g_mousepos);
    context.lineTo(endpoint.x,endpoint.y);
    context.stroke();
    drawPointSnapCrosshair(context,g_mousepos);
}

function pickPointAt(cursorPt) {
  vertex=null;
  minDist2=g_snapRadius*g_snapRadius;
  for (pli=0; pli<g_polys.length; pli++) {
    pl=g_polys[pli];
    for (pti=0; pti<pl.points.length; pti++) {
       d2=distSquared2d(pl.points[pti],cursorPt);
       if (d2<minDist2){
         minDist2=d2;
         vertex=pl.points[pti];    
       }  
    }
  }
  return vertex;
}

function pickOrMakePoint(cursorPt){
  vt=pickPointAt(cursorPt);
  if (vt) {return vt;}
  newpl=polyFromPoint(cursorPt,"");
  AddPoly(newpl);
  return newpl.points[0];
}

function IsVisible(pli){
   if (g_showAllPolys){return true;}
   return pli==g_currentPoly;
}

function pickPolyFeatureAt(cursorPt){
  picked={pointIndex:-1,polyIndex:-1,edgeIndex:-1,edgeFraction:0.0,point:{}};
  minDist2=10000*10000;

  for (pli=0; pli<g_polys.length; pli++) {
    if (!IsVisible(pli)){continue;}
    pl=g_polys[pli];

    // pick the polygon centre?
    centre=polyCentre(pl.points);
    d2=distSquared2d(centre,cursorPt);
    if (d2<minDist2 && d2<g_snapRadius*g_snapRadius){
       minDist2=d2;
       picked.edgeIndex=-1;
       picked.pointIndex=-1;
       picked.polyIndex=pli;
       picked.pickedPoint=centre;
    }
    // pick polygon Edge?
    for (pti=0; pti<pl.points.length; pti++) {
       pti1=(pti+1)%pl.points.length;
       edgeCentre=averagePoint(pl.points[pti],pl.points[pti1]);
       d2=distSquared2d(edgeCentre,cursorPt);
       if (d2<=minDist2){
         minDist2=d2;
         picked.polyIndex=pli;
         picked.edgeIndex=pti;
         picked.pointIndex=-1;
         picked.pickedPoint=edgeCentre;
       } 
    }    
    
    // pick polygon vertex?
    for (pti=0; pti<pl.points.length; pti++) {
      pt=pl.points[pti];
      d2=distSquared2d(pt,cursorPt);
      if (d2<=minDist2){
         minDist2=d2;
         picked.pointIndex=pti;
         picked.polyIndex=pli;
         picked.edgeIndex=-1;
         picked.pickedPoint=pt;
      }
    }

    
  }
  return picked;
}

function drawFeedbackPoly(context){
    if (g_drawingPoly.length>0){
      context.globalAlpha=0.75;
      context.strokeStyle = "red";
      endpt=g_mousepos;
      if (distSquared2d(g_drawingPoly[0],g_mousepos)<g_snapRadius*g_snapRadius) {
        endpt=g_drawingPoly[0];
        context.strokeStyle = "green";
        context.globalAlpha=1.0;
      }
      context.beginPath();
      context.moveTo(g_drawingPoly[0].x,g_drawingPoly[0].y);
      for (i=1; i<g_drawingPoly.length; i++){
        context.lineTo(g_drawingPoly[i].x,g_drawingPoly[i].y);
      }
      context.lineTo(endpt.x,endpt.y);
      context.stroke();
    }
    dragFeedbackCrosshair(context);
}

function polyCentre(poly){
   tx=0,ty=0;
   for (i=0; i<poly.length; i++){
     tx+=poly[i].x; ty+=poly[i].y;
   }
   return {x: tx/poly.length, y:ty/poly.length};
}

function drawFeedbackPickPolyPoint(ctx) {
  picked = g_adjustPoint?g_adjustPoint:pickPolyFeatureAt(g_mousepos);
  if (picked.polyIndex>=0) {
     pt=(picked.edgeIndex>=0)?picked.pickedPoint:(picked.pointIndex>=0)?g_polys[picked.polyIndex].points[picked.pointIndex]:picked.pickedPoint;
   
    fillCircle(ctx,pt.x,pt.y,g_snapRadius);
     
  }
}
function drawCrosshairFull(context,cursor){
  context.strokeStyle="#ffffff";
  context.globalAlpha=0.5;
  context.beginPath();
  context.moveTo(cursor.x,0);
  context.lineTo(cursor.x,1080);
  context.stroke();
  context.beginPath();
  context.moveTo(0,cursor.y);
  context.lineTo(1920,cursor.y);
  context.stroke();
}
function drawCrosshair(context,cursor,size){
  context.strokeStyle="#ffffff";
  context.globalAlpha=0.5;
  context.beginPath();
  context.moveTo(cursor.x,cursor.y-size);
  context.lineTo(cursor.x,cursor.y+size);
  context.stroke();
  context.beginPath();
  context.moveTo(cursor.x-size,cursor.y);
  context.lineTo(cursor.x+size,cursor.y);
  context.stroke();
}

function repaint() {
  var canvas = document.querySelector("canvas");
  var context = canvas.getContext("2d");
  if (!g_img.ready) {
    
    context.font = "20px Arial";
    context.fillText("loading\n"+g_img.src,0,0);

    return;
  }
  if (g_currentPoly>g_polys.length){currentPoly=-1;}
  g_showLabelNames=document.getElementById("showLabels").checked;
  g_showAllPolys=document.getElementById("showAllPolys").checked;  
  console.log(document.getElementById("showLabels").checked);
 
  context.globalAlpha=1.0;
  img=g_img;
  context.drawImage(img,0,0,img.width,img.height,0,0,g_scaled_w,g_scaled_h);

  context.globalAlpha=0.5;

  context.fillStyle = "green";

  context.strokeStyle="#00ff00";
  var textHeight;
  if (g_polys.length<8){
    textHeight=20.0;
    context.font = "20px Arial";
  } else if(g_polys.length<16){
    textHeight=15.0;
    context.font = "15px Arial";
  }else{
    textHeight=10.0;
    context.font = "10px Arial";
  }

  // Show polys
  for (pli=0; pli<g_polys.length; pli++){
    if (!IsVisible(pli)) continue;
    pl=g_polys[pli];

    // account for selection in rendering style.
    currentPolyOutlineColor = (pli==g_currentPoly)?g_currentPolyOutline:pl.color;


    // fill the area
    context.globalAlpha=0.25;
    if (pl.points.length>2){
      context.beginPath();
      context.moveTo(pl.points[pl.points.length-1].x,pl.points[pl.points.length-1].y);
      for (j=0; j<pl.points.length; j++) {
        context.lineTo(pl.points[j].x,pl.points[j].y);
      }
      context.closePath();
      context.fillStyle = pl.color;
      context.fill();
    }

    context.globalAlpha=0.75;
    context.fillStyle=currentPolyOutlineColor;
    if (g_showVertices){
      for (j=0; j<pl.points.length; j++) {
        fillCircle(context,pl.points[j].x,pl.points[j].y,g_snapRadius/2)
      }
    }

    // stroke the outline
    context.strokeStyle = currentPolyOutlineColor;
    context.globalAlpha=0.75;
    context.beginPath();
    context.moveTo(pl.points[pl.points.length-1].x,pl.points[pl.points.length-1].y);
    for (j=0; j<pl.points.length; j++) {
      context.lineTo(pl.points[j].x,pl.points[j].y);
    }
    context.stroke();
    // draw the label name.
    context.globalAlpha=0.75;
    pos=polyCentre(pl.points);
    if (g_showLabelNames){
      var textWidth = context.measureText(pl.name).width;
   
// text label black background
//       context.globalAlpha=(pli==g_currentPoly)?0.5:0.25;
//      context.fillStyle = "black";
//      context.fillRect(pos.x-textWidth/2,pos.y-textHeight/2, textWidth, textHeight);
      context.globalAlpha=(pli==g_currentPoly)?1.0:0.75;
      context.fillStyle = g_labelColor;
      context.fillText(pl.name,pos.x-textWidth/2,pos.y+textHeight/2);
    }
  }

  // show current tool feedback
  if (g_drawfeedback){
    g_drawfeedback(context);
  }

}


function getCurrentLabel(){
// get the entered label and cache it.
val= document.getElementById("currentLabel").value; g_presetLabels[g_presetLabelIndex]=val; return val;}
function setCurrentLabel(newval){document.getElementById("currentLabel").value=newval;}

function IncWrap(val,inc,max){
  if (max==0) return 0;
  next=val+inc;
  if (next<0)next+=max;  
  return next%max;
}
function TogglePresetLabel(dir){
  g_presetLabelIndex=IncWrap(g_presetLabelIndex,dir,g_presetLabels.length);
  setCurrentLabel(g_presetLabels[g_presetLabelIndex]);
}
function ToggleCurrentPoly(dir){
  g_currentPoly=IncWrap(g_currentPoly,dir,g_polys.length);  
  repaint();
}


// rectangular-drag creation tools -
// several variations for different actual shapes

function makeRectToolVariant(polyCreateFn){
  return{
    activate: function(e){
       g_drawfeedback=dragFeedbackCrosshairFull;
    },
    mousedown: function(e){
      g_drawfeedback=dragFeedbackRect;
    },
    mousemove: function(e){
    },
    mouseup:function(e){
        newrect={start:g_dragstart,end:g_mousepos,name: getCurrentLabel()};
    
        if (distSquared2d(g_dragstart,g_mousepos)>0){
          AddPoly(polyCreateFn(newrect));
        }
        g_drawfeedback=dragFeedbackCrosshairFull;
    }
  }
}

g_hexTool=makeRectToolVariant(polyDiagonalHexFromRect);
g_octTool=makeRectToolVariant(polyOctFromRect);
g_rectTool=makeRectToolVariant(polyFromRect);

g_lineTool={
  name:"draw edges",
  activate: function(e){
     g_drawfeedback=dragFeedbackCrosshair;
  },

  mousedown: function(e){
      g_drawfeedback=dragFeedbackLine;
  },
  mouseup:function(e){
      
      newline={start:g_dragstart,end:g_mousepos};
      // only issue if there is length.
      if (distSquared2d(g_dragstart,g_mousepos)>0){
        vstart=pickOrMakePoint(g_dragstart);
        vend=pickOrMakePoint(g_mousepos);
        AddPoly({points:[vstart,vend], name:getCurrentLabel()});
      }
      g_drawfeedback=dragFeedbackCrosshair;
  },
  cancel:function(){
      g_dragstart=g_mousepos;
      g_drawfeedback=dragFeedbackCrosshair;
  }
};

g_polyTool={
  name:"draw polygon",
  activate: function(e){
     g_drawfeedback=dragFeedbackCrosshair;
  },

  mousedown: function(e){
      g_drawfeedback=drawFeedbackPoly;
      console.log("add poly point");
      if (g_drawingPoly.length>2){
        if (distSquared2d(g_mousepos,g_drawingPoly[0])<g_snapRadius*g_snapRadius){
          console.log("finish poly");
          AddPoly({points:g_drawingPoly,name:getCurrentLabel()});
          g_drawingPoly=[];
          return;
        }
      }
      g_drawingPoly.push(g_mousepos);

  },
  mouseup:function(e){
  },
  cancel:function(){
     g_drawingPoly=[];
  }
};
g_adjustPoint=null;

g_pointTool={
  name:"draw points",
  activate:function(e){
    g_adjustPoint=null;
    g_drawfeedback=dragFeedbackCrosshair;
  },
  mousedown: function(e){
      console.log("add  point");
      AddPoly(polyFromPoint(g_mousepos,getCurrentLabel()));
  },
  mouseup: function(e){
  },
  mousemove: function(e){
  }
};

g_moveTool={
  name:"move vertices/edgesplit",
  activate:function(e){
    g_drawfeedback=drawFeedbackPickPolyPoint;
  },
  mousemove: function(e){
    if (g_adjustPoint){
      //can only adjust current poly

      // edge split operation?
      if (g_adjustPoint.edgeIndex>=0){
        console.log("move tool-split edge.");
        pl=g_polys[g_adjustPoint.polyIndex];
        pti1=(g_adjustPoint.edgeIndex+1)%pl.points.length;
        newPt=averagePoint(pl.points[g_adjustPoint.edgeIndex],pl.points[pti1]);
        //newPt=g_mousepos;

        // 2 types of edgeplit, if the poly is just an edge, make 2 polys with new vertex
        // else split in the boundary
        if (g_polys[g_adjustPoint.polyIndex].points.length==2){
          splitpoly=g_polys[g_adjustPoint.polyIndex];
          midpointobj=polyFromPoint(newPt,splitpoly.name);
          AddPoly( midpointobj);
          AddPoly( polyFromLine(midpointobj.points[0],splitpoly.points[1], splitpoly.name));
          splitpoly.points[1]=midpointobj.points[0];
          g_adjustPoint.pointIndex=1;
          g_adjustPoint.edgeIndex=-1;
        } else{
           //true poly split.
          g_polys[g_adjustPoint.polyIndex].points.splice(g_adjustPoint.edgeIndex+1,0,newPt);
         // re-pick the poly
 //       g_adjustPoint=pickPolyFeatureAt(g_mousepos);

          g_adjustPoint.pointIndex=g_adjustPoint.edgeIndex+1;
          g_adjustPoint.edgeIndex=-1;
        }

      }

      pl=g_polys[g_adjustPoint.polyIndex];
      if (g_adjustPoint.pointIndex>=0 ){
        //move a vertex..
        pl.points[g_adjustPoint.pointIndex].x+=g_mouseDelta.x;
        pl.points[g_adjustPoint.pointIndex].y+=g_mouseDelta.y;
      } else if (g_adjustPoint.edgeIndex<0 && g_adjustPoint.pointIndex<0) {
        // move the whole poly..
        for (pti=0; pti<pl.points.length;pti++){
          pl.points[pti].x+=g_mouseDelta.x;
          pl.points[pti].y+=g_mouseDelta.y;
        }
      }
    }
  },
  mousedown: function(e){
    pick=pickPolyFeatureAt(g_mousepos);
    if (pick.polyIndex>=0){
      g_currentPoly=pick.polyIndex;
      g_adjustPoint=pick;
      if (pick.pointIndex>=0){
        console.log("move point..");
      }

    }
  },
  mouseup: function(e){
    g_adjustPoint=null;
  },
  // cancel,bound to escape key
  cancel: function(){
    g_adjustPoint=null;
  }
};

g_tool=g_hexTool;

function SetTool(tool){
  if (g_tool){
    if (g_tool.deactivate){
      g_tool.deactivate();
    }
  }
  g_tool=tool;
  if (tool.activate){
    tool.activate();
  }
}

// todo create these+buttons programatically
document.getElementById("poly").onclick=function(){SetTool(g_polyTool);};
document.getElementById("line").onclick=function(){SetTool(g_lineTool);};
document.getElementById("point").onclick=function(){SetTool(g_pointTool);};
document.getElementById("rect").onclick=function(){SetTool(g_hexTool);};
document.getElementById("edit").onclick=function(){SetTool(g_moveTool);};

// JSON dump. TODO - connect to a server etc etc

function download(filename, text) {
  var element = document.createElement('a');
  element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
  element.setAttribute('download', filename);

  element.style.display = 'none';
  document.body.appendChild(element);

  element.click();

  document.body.removeChild(element);
}

function GetAsJSON(){
  return JSON.stringify(
   { imageurl:      g_img.src,//document.getElementById("imageurl").value,
     scaled_width:  g_scaled_w,
     scaled_height: g_scaled_h,
     polygons:      g_polys
   });
}
var g_downloadIndex=0;

// load the scene from a text file
function loadFromText(txt){
   var inputJSON=JSON.parse(txt);
   if (!inputJSON){
     alert("must load JSON format");
     return;
   }
   if (!inputJSON.imageurl && inputJSON.polygons){
     alert("incorret format, needs imageurl,polygons");
     return;
   }

   alert("Loading annotations for:"+inputJSON.imageurl);
//   LoadImage(inputJSON.imageurl); // doesnt work.. 
   // todo- how to safely set UI etc
   g_img.src=inputJSON.imageurl;
//   document.getElementById("imageurl").value;
   console.log("setting new polys,num= "+inputJSON.polygons.length);
   g_polys=inputJSON.polygons;
}

document.getElementById("save").onclick=function(){
   filename=prompt("download as","annotations"+g_downloadIndex+".json"); g_downloadIndex+=1;
//   alert(GetAsJSON());
   download(filename,GetAsJSON());
};

// drag drop the annotation file in for load.
editor.ondragover=function(ev){
  console.log("dragover");
  ev.preventDefault();
}
editor.ondrop=function(ev){
  console.log("got a drop");
  ev.preventDefault();
  var dt=ev.dataTransfer;
  var files = ev.target.files || ev.dataTransfer.files;

  for (var i=0,file; file=files[i];i++){
    console.log("got file drop:"+file+" l="+file.length); 
    reader = new FileReader();
    reader.onload = function(event) {
        console.log("file loaded:"+event.target);
        data = event.target.result;
        console.log("file loaded bytes="+data.length);
        loadFromText(data);        
    };
    reader.readAsText(file);

  }
}


document.getElementById("load").onclick=function(){
   var txt=prompt("enter JSON annotations");
   if (!txt){return;}
   
   // grab the stuff.
   loadFromText(txt);
};

function readMousePos(e){
  var edrect = editor.getBoundingClientRect();

  opos=g_mousepos;g_mousepos={x:e.clientX-edrect.left,y:e.clientY-edrect.top}; g_mouseDelta.x=g_mousepos.x-opos.x; g_mouseDelta.y=g_mousepos.y-opos.y;}
editor.addEventListener('mousemove',function(e){
  readMousePos(e);
  if (g_tool.mousemove) {g_tool.mousemove(e);}
  repaint();
});

function RenamePoly(){
  if (g_polys.length<=0) return;
  currentPoly=g_polys[g_currentPoly];
  newname=prompt("enter new label",currentPoly.name);
  currentPoly.name=newname;
  console.log(g_defaultColors[newname]);
  if (g_defaultColors[newname]){
    currentPoly.color=g_defaultColors[newname];
  }
}

function DeleteCurrentPoly(){
  if (g_currentPoly>=0 && g_polys.length>0){
    if (confirm("delete poly:"+g_polys[g_currentPoly].name)){
      g_polys.splice(g_currentPoly,1);
      g_currentPoly=IncWrap(g_currentPoly,0,g_polys.length);
    }
  }
}

editor.addEventListener('mousedown', function(e){readMousePos(e);g_dragstart=g_mousepos;g_tool.mousedown(e); repaint();});
editor.addEventListener('mouseup',   function(e){readMousePos(e);g_tool.mouseup(e);repaint();});
window.addEventListener('keydown',  function(e){
  kc=e.keyCode;
  console.log("keypress:"+kc);
  // todo - programatic, show hotkeys.
  if (kc==82){SetTool(g_hexTool)} 
  if (kc==66){SetTool(g_octTool)} 
  else if (kc==69){SetTool(g_moveTool)}
  else if (kc==80){SetTool(g_polyTool)}
  else if (kc==79){SetTool(g_pointTool)}
  else if (kc==76){SetTool(g_lineTool)}
  else if (kc==221){TogglePresetLabel(1);}
  else if (kc==219){TogglePresetLabel(-1);}
  else if (kc==27){g_tool.cancel();}
  else if (kc==13){RenamePoly();}
  else if (kc==188){ToggleCurrentPoly(-1);}
  else if (kc==190){ToggleCurrentPoly(+1);}
  else if (kc==8){DeleteCurrentPoly(+1);}
// todo .. parenting, renaming , delete vertex,...
  readMousePos(e);repaint();
},false);

repaint();

var example1Labels=
[{"points":[{"x":805,"y":406.94},{"x":768,"y":403},{"x":699.75,"y":411},{"x":671,"y":432},{"x":627,"y":442.5},{"x":627,"y":468.06},{"x":634,"y":489},{"x":660,"y":491},{"x":670,"y":478},{"x":684,"y":490},{"x":700.25,"y":492},{"x":728,"y":489},{"x":752,"y":486},{"x":757,"y":475},{"x":776,"y":476},{"x":785,"y":489},{"x":807,"y":485.5},{"x":810,"y":467},{"x":825,"y":464},{"x":825,"y":438}],"name":"suv","color":"#ff0000"},{"points":[{"x":316.155,"y":393},{"x":323.875,"y":392},{"x":337,"y":406.75},{"x":339,"y":433},{"x":332,"y":448},{"x":333.845,"y":478},{"x":320.125,"y":478},{"x":316,"y":453},{"x":314,"y":426.25},{"x":308,"y":420},{"x":315,"y":405}],"name":"man","color":"#0000ff"},{"points":[{"x":282.09,"y":386},{"x":272.25,"y":380},{"x":265,"y":395},{"x":261,"y":406.25},{"x":262,"y":431},{"x":259.91,"y":455},{"x":276.75,"y":455},{"x":274,"y":443},{"x":278,"y":415.75},{"x":287,"y":411},{"x":288,"y":404},{"x":278,"y":404},{"x":278,"y":396}],"name":"man","color":"#0000ff"},{"points":[{"x":249,"y":446.815},{"x":222,"y":443},{"x":171,"y":420},{"x":107,"y":421},{"x":67,"y":427},{"x":11,"y":453},{"x":1,"y":451.625},{"x":2,"y":527.185},{"x":32,"y":528},{"x":48,"y":517},{"x":172,"y":513},{"x":181,"y":522},{"x":211,"y":520},{"x":222,"y":506},{"x":249,"y":501.375},{"x":254,"y":468}],"name":"sedan","color":"#008000"},{"points":[{"x":942,"y":407.73},{"x":897,"y":405},{"x":853.25,"y":411},{"x":831,"y":429.75},{"x":816,"y":436},{"x":814,"y":462.27},{"x":823,"y":483},{"x":865.75,"y":486},{"x":890,"y":482},{"x":899,"y":470},{"x":924,"y":470},{"x":932,"y":478},{"x":951,"y":475.25},{"x":962,"y":460},{"x":960,"y":427}],"name":"suv","color":"#ff0000"},{"points":[{"x":1019.97,"y":410},{"x":971.25,"y":410},{"x":964,"y":417.625},{"x":965.03,"y":470},{"x":1014.75,"y":471},{"x":1022,"y":463.375}],"name":"sedan","color":"#008000"},{"points":[{"x":423.98,"y":388},{"x":447.5,"y":388},{"x":451,"y":397.25},{"x":450.02,"y":462},{"x":426.5,"y":462},{"x":423,"y":452.75}],"name":"man","color":"#0000ff"},{"points":[{"x":423.16,"y":391},{"x":403,"y":391},{"x":400,"y":399.75},{"x":400.84,"y":461},{"x":421,"y":461},{"x":424,"y":452.25}],"name":"woman","color":"#2000f0"},{"points":[{"x":591,"y":378.395},{"x":569,"y":362},{"x":539.5,"y":356},{"x":502,"y":365.125},{"x":478,"y":390},{"x":477,"y":435},{"x":502,"y":456.605},{"x":532,"y":448},{"x":593.5,"y":452},{"x":606,"y":428.875},{"x":605,"y":397}],"name":"bush","color":"#00ff00"},{"points":[{"x":701,"y":238.915},{"x":685,"y":244},{"x":672.25,"y":236},{"x":659,"y":249},{"x":651,"y":240},{"x":636,"y":254},{"x":618,"y":248},{"x":611,"y":259},{"x":589,"y":250.125},{"x":565,"y":279},{"x":564,"y":297},{"x":549,"y":312},{"x":562,"y":325},{"x":555,"y":335},{"x":554,"y":348},{"x":565,"y":350},{"x":578,"y":358},{"x":593,"y":378.085},{"x":619,"y":387},{"x":638,"y":396},{"x":638,"y":439},{"x":650,"y":436},{"x":649,"y":399},{"x":657.75,"y":399},{"x":690,"y":387},{"x":713,"y":387.875},{"x":726,"y":393},{"x":747,"y":371},{"x":739,"y":361},{"x":748,"y":350},{"x":746,"y":337},{"x":722,"y":325},{"x":724,"y":313},{"x":732,"y":299},{"x":734,"y":282},{"x":704,"y":286},{"x":712,"y":280},{"x":696,"y":270},{"x":695,"y":259},{"x":708,"y":256}],"name":"tree","color":"#00ff00"}]

var example2Labels=[{"points":[{"x":665,"y":474.625},{"x":611,"y":459},{"x":577.75,"y":460},{"x":554,"y":473},{"x":515,"y":485.375},{"x":516,"y":505.375},{"x":527,"y":512},{"x":572.25,"y":514},{"x":659,"y":515.625},{"x":672,"y":492}],"name":"convertible car","color":"#ff0000"},{"points":[{"x":675,"y":469.96},{"x":717,"y":451},{"x":757.25,"y":451},{"x":760,"y":466},{"x":755,"y":477.04},{"x":728.75,"y":480},{"x":724,"y":508},{"x":693,"y":509},{"x":674,"y":498}],"name":"sedan","color":"#008000"},{"points":[{"x":833.62,"y":481},{"x":774.5,"y":481},{"x":771,"y":508.625},{"x":770.38,"y":546},{"x":827.5,"y":546},{"x":832,"y":539.375},{"x":834,"y":507}],"name":"roadworks","color":"#008000"},{"points":[{"x":635.145,"y":219},{"x":628,"y":202},{"x":590.625,"y":204},{"x":589,"y":222.625},{"x":585.855,"y":308},{"x":619.375,"y":308},{"x":628,"y":286},{"x":632,"y":269.375}],"name":"chimney","color":"#008000"},{"points":[{"x":221,"y":470.065},{"x":252,"y":458},{"x":266,"y":463},{"x":269,"y":472},{"x":284,"y":468},{"x":304,"y":459},{"x":320,"y":463},{"x":329,"y":456},{"x":341,"y":465},{"x":357.75,"y":454},{"x":366,"y":460},{"x":384,"y":459},{"x":400,"y":471},{"x":406,"y":490.375},{"x":404,"y":504.935},{"x":351,"y":505},{"x":298,"y":507},{"x":262.25,"y":506},{"x":223,"y":502.625}],"name":"bush","color":"#00ff00"},{"points":[{"x":212,"y":190.72},{"x":231,"y":210},{"x":241.5,"y":237},{"x":240,"y":244},{"x":259,"y":258},{"x":257,"y":247},{"x":281,"y":231},{"x":295,"y":242},{"x":314,"y":234},{"x":331,"y":244},{"x":338,"y":264},{"x":356,"y":268},{"x":363,"y":286},{"x":370,"y":262},{"x":381,"y":245},{"x":395,"y":270},{"x":412,"y":281},{"x":391,"y":283},{"x":334,"y":373.28},{"x":262,"y":375},{"x":234,"y":395},{"x":222.5,"y":393},{"x":223,"y":326},{"x":231,"y":315},{"x":187,"y":260},{"x":188,"y":260},{"x":188,"y":249},{"x":204,"y":245},{"x":210,"y":230},{"x":205,"y":215},{"x":206,"y":195}],"name":"trees","color":"#00ff00"},{"points":[{"x":469,"y":447.12},{"x":482,"y":451},{"x":490,"y":460},{"x":496,"y":449},{"x":504,"y":448},{"x":509.75,"y":447},{"x":522,"y":459},{"x":526,"y":464.88},{"x":504,"y":472},{"x":486,"y":466},{"x":480.25,"y":479},{"x":457,"y":470},{"x":459,"y":459}],"name":"people","color":"#1000f0"},{"points":[{"x":655.44,"y":435},{"x":642,"y":435},{"x":640,"y":439},{"x":640.56,"y":467},{"x":654,"y":467},{"x":656,"y":463}],"name":"man","color":"#0000ff"},{"points":[{"x":608.735,"y":445},{"x":626.375,"y":445},{"x":629,"y":448.25},{"x":628.265,"y":471},{"x":610.625,"y":471},{"x":608,"y":467.75}],"name":"man","color":"#0000ff"},{"points":[{"x":78,"y":510.075},{"x":73,"y":475},{"x":76,"y":452},{"x":84,"y":441},{"x":78,"y":433},{"x":60,"y":444},{"x":50,"y":428},{"x":45,"y":416},{"x":0,"y":410.125},{"x":1,"y":589.925},{"x":50,"y":588},{"x":55,"y":580},{"x":78,"y":580},{"x":119,"y":563.875},{"x":143,"y":537},{"x":115,"y":520}],"name":"bush","color":"#00ff00"},{"points":[{"x":1.3650000000000002,"y":224},{"x":74,"y":235},{"x":76,"y":224},{"x":94,"y":220},{"x":117,"y":224},{"x":116,"y":239},{"x":153,"y":241},{"x":153,"y":212},{"x":171,"y":208},{"x":192.125,"y":212},{"x":189,"y":261.125},{"x":229,"y":314},{"x":223,"y":327},{"x":223,"y":393},{"x":233,"y":412},{"x":231,"y":421},{"x":224,"y":428},{"x":223.635,"y":509},{"x":78.875,"y":510},{"x":70,"y":473},{"x":86,"y":437},{"x":79,"y":432},{"x":61,"y":441},{"x":44,"y":415},{"x":-1,"y":408.875}],"name":"house","color":"#c04000"},{"points":[{"x":88,"y":511.42999999999995},{"x":349,"y":511},{"x":513,"y":500},{"x":530,"y":518},{"x":473,"y":518},{"x":452,"y":522},{"x":449,"y":532},{"x":475,"y":540},{"x":521,"y":544},{"x":619,"y":553},{"x":726,"y":558},{"x":883,"y":563},{"x":1024,"y":563.25},{"x":1026,"y":661.57},{"x":414,"y":662},{"x":218,"y":661.75},{"x":287,"y":634},{"x":300,"y":617},{"x":285,"y":593},{"x":251,"y":576},{"x":191,"y":565},{"x":142,"y":558},{"x":146,"y":537},{"x":115,"y":518}],"name":"road","color":"#008000"},{"points":[{"x":251,"y":576.08},{"x":191,"y":566},{"x":137.5,"y":558},{"x":137,"y":576},{"x":168,"y":585},{"x":156,"y":613},{"x":129,"y":627},{"x":4,"y":660.92},{"x":208.5,"y":662},{"x":287,"y":633},{"x":298,"y":617},{"x":286,"y":592}],"name":"pavement","color":"#008000"},{"points":[{"x":653,"y":516.61},{"x":722,"y":517},{"x":731,"y":522},{"x":779.25,"y":527},{"x":843,"y":534},{"x":986,"y":533},{"x":1023,"y":528.75},{"x":1020,"y":558.39},{"x":883,"y":560},{"x":699.75,"y":554},{"x":524,"y":543},{"x":455,"y":534.25},{"x":453,"y":523},{"x":473,"y":518}],"name":"pavement","color":"#008000"},{"points":[{"x":922.32,"y":163},{"x":936,"y":177},{"x":944,"y":167},{"x":953,"y":171},{"x":970,"y":178},{"x":976,"y":194},{"x":1000,"y":200},{"x":994,"y":222},{"x":1014,"y":202},{"x":1024,"y":210.625},{"x":1022,"y":422},{"x":981.68,"y":418},{"x":983,"y":364},{"x":1001,"y":351},{"x":966,"y":317},{"x":927,"y":282},{"x":923,"y":249},{"x":875,"y":239.375},{"x":873,"y":221},{"x":888,"y":217},{"x":885,"y":205},{"x":892,"y":192},{"x":901,"y":193}],"name":"trees","color":"#008000"},{"points":[{"x":748,"y":259.68},{"x":636,"y":269},{"x":635,"y":220},{"x":628,"y":201},{"x":588,"y":202},{"x":583,"y":272},{"x":393.75,"y":281},{"x":336,"y":374},{"x":261,"y":373},{"x":225,"y":396.32},{"x":224,"y":450},{"x":270,"y":453},{"x":289,"y":470},{"x":311,"y":458},{"x":330,"y":453},{"x":356,"y":454},{"x":387,"y":457},{"x":407,"y":461},{"x":409,"y":470},{"x":418,"y":461},{"x":420,"y":488},{"x":428,"y":487},{"x":427,"y":462},{"x":439,"y":443},{"x":454,"y":467},{"x":467,"y":447},{"x":518,"y":445},{"x":539,"y":464},{"x":566,"y":455},{"x":608.25,"y":460},{"x":695,"y":458},{"x":716,"y":450},{"x":755,"y":451},{"x":756,"y":366},{"x":736,"y":356},{"x":768,"y":322}],"name":"pub","color":"#008000"},{"points":[{"x":509,"y":245.205},{"x":523,"y":231},{"x":532,"y":234},{"x":540.75,"y":220},{"x":564,"y":227},{"x":572,"y":223},{"x":585,"y":230.875},{"x":585,"y":274.795},{"x":521.25,"y":278},{"x":492,"y":276},{"x":491,"y":269.125},{"x":512,"y":257}],"name":"tree","color":"#00ff00"},{"points":[{"x":678,"y":242.12},{"x":666,"y":241},{"x":645.75,"y":236},{"x":632,"y":241},{"x":632,"y":267.88},{"x":679.25,"y":269},{"x":695,"y":265},{"x":691,"y":252}],"name":"trees","color":"#008000"},{"points":[{"x":-1,"y":590.135},{"x":50,"y":589},{"x":52,"y":578},{"x":138,"y":578},{"x":166,"y":584.625},{"x":157,"y":613},{"x":131,"y":624},{"x":96,"y":642.865},{"x":-1,"y":660},{"x":2,"y":639.375}],"name":"grass","color":"#00ff00"},{"points":[{"x":833,"y":499.435},{"x":859,"y":501},{"x":968,"y":499},{"x":1004,"y":496},{"x":1024,"y":508.125},{"x":1026,"y":527},{"x":986,"y":532.565},{"x":851,"y":534},{"x":829,"y":532.875}],"name":"steps","color":"#008000"},{"points":[{"x":657,"y":453.945},{"x":687,"y":453},{"x":707,"y":456.375},{"x":696,"y":469.055},{"x":672,"y":476},{"x":672,"y":483},{"x":667,"y":473},{"x":651,"y":468.625}],"name":"bush","color":"#00ff00"},{"points":[{"x":801,"y":290.155},{"x":782,"y":296},{"x":758,"y":290.125},{"x":764,"y":309.845},{"x":764,"y":325},{"x":778,"y":311.875}],"name":"tree","color":"#00ff00"},{"points":[{"x":813,"y":257.835},{"x":834,"y":253},{"x":857,"y":238},{"x":863.25,"y":213},{"x":884,"y":240},{"x":922,"y":249.125},{"x":929,"y":284},{"x":998,"y":357.165},{"x":860.75,"y":358},{"x":731,"y":359},{"x":807,"y":284.875}],"name":"roof","color":"#008000"},{"points":[{"x":729,"y":481.19},{"x":756,"y":483},{"x":766,"y":484.25},{"x":766,"y":511},{"x":761,"y":514},{"x":762,"y":542.81},{"x":753,"y":545},{"x":753,"y":514},{"x":736,"y":515},{"x":734,"y":545},{"x":727,"y":545},{"x":727,"y":511},{"x":725,"y":509.75}],"name":"placename","color":"#008000"},{"points":[{"x":566,"y":423.015},{"x":607.75,"y":406},{"x":657,"y":427},{"x":639,"y":432.625},{"x":614,"y":433.985},{"x":589.25,"y":434},{"x":566,"y":429.375}],"name":"umbrella","color":"#008000"},{"points":[{"x":535,"y":420.945},{"x":490,"y":405},{"x":442,"y":424.375},{"x":465,"y":428.055},{"x":487,"y":429},{"x":512,"y":427.625}],"name":"umbrella","color":"#008000"},{"points":[{"x":357,"y":425.945},{"x":313.75,"y":408},{"x":285,"y":421.375},{"x":287,"y":426},{"x":284,"y":429.055},{"x":301.25,"y":429},{"x":329,"y":425.625}],"name":"umbrella","color":"#008000"},{"points":[{"x":227,"y":419.98},{"x":252.5,"y":409},{"x":293,"y":427.5},{"x":266,"y":432.02},{"x":242.5,"y":433},{"x":223,"y":433.5}],"name":"umbrella","color":"#008000"},{"points":[{"x":437,"y":453.575},{"x":449,"y":463},{"x":471,"y":458},{"x":485,"y":464},{"x":497,"y":458},{"x":505,"y":467},{"x":528,"y":460},{"x":543,"y":462},{"x":552,"y":452},{"x":579,"y":458.625},{"x":552,"y":476},{"x":521,"y":483},{"x":515,"y":495.425},{"x":464,"y":495},{"x":427,"y":489.375},{"x":426,"y":474}],"name":"bush","color":"#00ff00"},{"points":[{"x":223,"y":448.945},{"x":257,"y":448},{"x":280,"y":456.375},{"x":294,"y":470.055},{"x":276,"y":465},{"x":265,"y":469},{"x":255,"y":458},{"x":236,"y":457},{"x":226,"y":474},{"x":223,"y":471.625}],"name":"car","color":"#ff0000"},{"points":[{"x":341,"y":450.805},{"x":320,"y":455},{"x":306,"y":456},{"x":305.75,"y":447},{"x":297,"y":448.875},{"x":286,"y":459},{"x":286,"y":469.195},{"x":311.25,"y":461},{"x":346,"y":463.125}],"name":"people","color":"#1000f0"},{"points":[{"x":769,"y":611},{"x":707,"y":601},{"x":946,"y":564},{"x":1023,"y":566},{"x":1022,"y":573}],"name":"give way (road marking)","color":"#008000"},{"points":[{"x":522,"y":572}],"name":"","color":"#008000"},{"points":[{"x":522,"y":572},{"x":769,"y":611}],"name":"road centreline","color":"#008000"},{"points":[{"x":1,"y":-0.9950000000000045},{"x":615.5,"y":-1},{"x":1027,"y":-0.125},{"x":1025,"y":210.995},{"x":1011,"y":208},{"x":1003,"y":215},{"x":993,"y":221},{"x":994,"y":216},{"x":1002,"y":206},{"x":990,"y":198},{"x":984,"y":192},{"x":969,"y":191},{"x":965,"y":180},{"x":962,"y":172},{"x":938,"y":174},{"x":933,"y":167},{"x":923,"y":163},{"x":906,"y":180},{"x":901,"y":192},{"x":882,"y":194},{"x":873,"y":204},{"x":872,"y":215},{"x":878,"y":224},{"x":894,"y":224},{"x":888,"y":210},{"x":898,"y":185},{"x":883,"y":187},{"x":874,"y":185},{"x":871,"y":164},{"x":869,"y":137},{"x":864,"y":163},{"x":861,"y":185},{"x":850,"y":188},{"x":845,"y":185},{"x":835,"y":185},{"x":831,"y":190},{"x":834,"y":197},{"x":845,"y":197},{"x":854,"y":194},{"x":862,"y":205},{"x":864,"y":211},{"x":860,"y":239},{"x":814,"y":257},{"x":794,"y":296},{"x":771,"y":294},{"x":755,"y":282},{"x":749,"y":260},{"x":696,"y":263},{"x":679,"y":245},{"x":638,"y":235},{"x":626,"y":204},{"x":610,"y":199},{"x":591,"y":207},{"x":585,"y":232},{"x":545,"y":222},{"x":515,"y":240},{"x":514,"y":255},{"x":501,"y":265},{"x":496,"y":279},{"x":408.5,"y":281},{"x":398,"y":273},{"x":393,"y":261},{"x":378,"y":248},{"x":377,"y":260},{"x":373,"y":266},{"x":365,"y":284},{"x":357,"y":282},{"x":356,"y":268},{"x":336,"y":266},{"x":332,"y":248},{"x":322,"y":243},{"x":320,"y":233},{"x":295,"y":241},{"x":290,"y":232},{"x":280,"y":234},{"x":271,"y":241},{"x":262,"y":242},{"x":255,"y":246},{"x":261,"y":257},{"x":249,"y":256},{"x":238,"y":244},{"x":245,"y":233},{"x":236,"y":225},{"x":231,"y":211},{"x":223,"y":205},{"x":215,"y":194},{"x":206,"y":195},{"x":210,"y":207},{"x":205,"y":214},{"x":209,"y":232},{"x":204,"y":247},{"x":189,"y":251},{"x":189,"y":231},{"x":190,"y":211},{"x":171,"y":207},{"x":149,"y":214},{"x":157,"y":220},{"x":155,"y":244},{"x":112,"y":242},{"x":115,"y":225},{"x":90,"y":219},{"x":73,"y":225},{"x":76,"y":235},{"x":0,"y":227.125}],"name":"sky","color":"#008000"},{"points":[{"x":-1,"y":224.925},{"x":154.5,"y":242},{"x":170,"y":265},{"x":187,"y":262.875},{"x":231,"y":317.075},{"x":64.5,"y":304},{"x":0,"y":300.125}],"name":"roof","color":"#008000"},{"points":[{"x":392,"y":282.835},{"x":587.5,"y":274},{"x":586,"y":309},{"x":620,"y":310},{"x":635,"y":269},{"x":747,"y":261.125},{"x":714,"y":363.165},{"x":521,"y":367},{"x":538,"y":387},{"x":576,"y":415},{"x":562,"y":422},{"x":537,"y":424},{"x":488.5,"y":406},{"x":442,"y":426},{"x":361,"y":424},{"x":313,"y":408},{"x":286,"y":425},{"x":251,"y":409},{"x":229,"y":420},{"x":264,"y":376},{"x":333,"y":373.875}],"name":"roof","color":"#008000"}];

var fullExample={"imageurl":"https://upload.wikimedia.org/wikipedia/commons/9/96/Sakeham_Farm_10.jpg",
"scaled_width":1024,"scaled_height":768,"polygons":[{"points":[{"x":311,"y":107.255},{"x":336,"y":106},{"x":340,"y":132},{"x":338,"y":160},{"x":439,"y":160},{"x":442,"y":157},{"x":459,"y":155},{"x":459,"y":148},{"x":468,"y":147},{"x":469,"y":156},{"x":480,"y":162},{"x":618.25,"y":167},{"x":615,"y":173},{"x":657,"y":202.625},{"x":664,"y":238},{"x":659,"y":243},{"x":658,"y":261},{"x":660,"y":277},{"x":702,"y":319},{"x":705,"y":392.745},{"x":411,"y":396},{"x":307.75,"y":399},{"x":247,"y":393.375},{"x":248,"y":260},{"x":238,"y":259},{"x":242,"y":228},{"x":290,"y":183},{"x":293,"y":159},{"x":309,"y":158}],"name":"house","color":"#c04000"},{"points":[{"x":33,"y":342.675},{"x":61,"y":332},{"x":84,"y":319},{"x":138,"y":311},{"x":168,"y":324},{"x":180,"y":351.125},{"x":215,"y":366},{"x":218,"y":399},{"x":200,"y":402.325},{"x":71,"y":406},{"x":28,"y":392.875}],"name":"bush","color":"#00ff00"},{"points":[{"x":3,"y":450.115},{"x":237,"y":452},{"x":389.25,"y":447},{"x":478,"y":448.125},{"x":506,"y":458},{"x":518,"y":477},{"x":412,"y":492},{"x":399,"y":505},{"x":330,"y":514.885},{"x":234,"y":520},{"x":147.75,"y":517},{"x":3,"y":524.875}],"name":"frosted grass","color":"#008000"},{"points":[{"x":404,"y":400.89},{"x":540,"y":395},{"x":748.5,"y":399},{"x":876,"y":404},{"x":1024,"y":407.75},{"x":1024,"y":447.11},{"x":907,"y":450},{"x":763,"y":457},{"x":558.5,"y":453},{"x":378,"y":443.25},{"x":418,"y":423}],"name":"grass","color":"#00ff00"},{"points":[{"x":38.760000000000005,"y":251},{"x":24,"y":253},{"x":23,"y":240},{"x":29,"y":242},{"x":31,"y":234},{"x":7,"y":231},{"x":14,"y":238},{"x":12,"y":252},{"x":-1,"y":250.625},{"x":-2.76,"y":321},{"x":22,"y":316},{"x":40,"y":339},{"x":114,"y":309},{"x":97,"y":300},{"x":67,"y":301.375},{"x":36,"y":265}],"name":"house","color":"#c04000"},{"points":[{"x":655,"y":3.645000000000003},{"x":871.5,"y":2},{"x":1024,"y":-1.125},{"x":1025,"y":357.355},{"x":989,"y":360},{"x":1004,"y":409},{"x":952,"y":405},{"x":955,"y":362},{"x":947,"y":357},{"x":936,"y":364},{"x":945,"y":421},{"x":935,"y":421},{"x":923,"y":373},{"x":893,"y":360},{"x":874,"y":347},{"x":849,"y":370},{"x":815,"y":400},{"x":768,"y":394},{"x":717.5,"y":370},{"x":689,"y":361},{"x":694,"y":302},{"x":714,"y":276},{"x":693,"y":265},{"x":689,"y":237},{"x":708,"y":220},{"x":733,"y":213},{"x":765,"y":222},{"x":755,"y":258},{"x":790,"y":244},{"x":762,"y":208},{"x":774,"y":189},{"x":750,"y":175},{"x":773,"y":157},{"x":685,"y":213.125},{"x":661,"y":155},{"x":613,"y":140},{"x":605,"y":88},{"x":652,"y":80},{"x":668,"y":89},{"x":665,"y":76},{"x":648,"y":34}],"name":"trees","color":"#00ff00"},{"points":[{"x":331.975,"y":373},{"x":361.375,"y":356},{"x":394,"y":370.75},{"x":406.025,"y":413},{"x":403,"y":432},{"x":373,"y":446},{"x":335.625,"y":444},{"x":325,"y":432.25},{"x":317,"y":400}],"name":"bush","color":"#00ff00"},{"points":[{"x":1,"y":525.95},{"x":146,"y":518},{"x":329,"y":515},{"x":400,"y":503},{"x":411,"y":493},{"x":434,"y":485},{"x":465,"y":485},{"x":510,"y":478},{"x":512,"y":469},{"x":505,"y":456},{"x":509,"y":450},{"x":558,"y":454},{"x":760.5,"y":458},{"x":908,"y":452},{"x":1025,"y":449.25},{"x":1022,"y":663.05},{"x":270.5,"y":662},{"x":0,"y":662.75}],"name":"river","color":"#008000"}]};

var examples=[
  {imageurl:"https://upload.wikimedia.org/wikipedia/commons/thumb/5/56/Queen_Street_NOTL_1.jpg/1920px-Queen_Street_NOTL_1.jpg",
  labels:example1Labels},
  {imageurl:"https://upload.wikimedia.org/wikipedia/commons/0/0a/Ickenham_-_water_pump%2C_pub%2C_and_houses_-_geograph.org.uk_-_20123.jpg",
  labels:example2Labels},
{"imageurl":"https://upload.wikimedia.org/wikipedia/commons/5/5f/Vendeur_de_parapluie.jpg","scaled_width":1024,"scaled_height":768,"polygons":[{"points":[{"x":641.2,"y":133},{"x":631,"y":123},{"x":616,"y":118},{"x":602,"y":119},{"x":592,"y":124},{"x":589,"y":137},{"x":573,"y":144.375},{"x":577,"y":153},{"x":592,"y":154},{"x":595,"y":170},{"x":579,"y":243},{"x":563,"y":281},{"x":586,"y":308},{"x":590,"y":340},{"x":592,"y":388},{"x":576,"y":397},{"x":575.8,"y":407},{"x":593,"y":420},{"x":627,"y":417},{"x":633,"y":370},{"x":629,"y":333},{"x":636,"y":306.625},{"x":644,"y":276},{"x":648,"y":255},{"x":655,"y":200},{"x":638,"y":169},{"x":630,"y":151},{"x":640,"y":148}],"name":"person","color":"#1000f0"},{"points":[{"x":454.655,"y":155},{"x":461,"y":137},{"x":479,"y":129},{"x":506,"y":151},{"x":540.375,"y":153},{"x":583,"y":210.5},{"x":576,"y":293},{"x":571,"y":335},{"x":558.345,"y":388},{"x":533,"y":380},{"x":540,"y":363},{"x":506,"y":370},{"x":495.625,"y":364},{"x":523,"y":344},{"x":524,"y":308.5},{"x":493,"y":273},{"x":497,"y":237},{"x":485,"y":186},{"x":463,"y":175}],"name":"person","color":"#1000f0"},{"points":[{"x":659,"y":205.215},{"x":667,"y":190},{"x":679,"y":185},{"x":689,"y":187},{"x":685,"y":175},{"x":693,"y":164},{"x":720,"y":171},{"x":713,"y":197},{"x":743,"y":200},{"x":748.75,"y":193},{"x":814,"y":185.625},{"x":814,"y":207},{"x":797,"y":208},{"x":800,"y":197},{"x":776,"y":202},{"x":772,"y":209},{"x":777,"y":222},{"x":796,"y":228},{"x":812,"y":250},{"x":819,"y":284},{"x":810,"y":311.785},{"x":799,"y":323},{"x":777,"y":326},{"x":750,"y":307},{"x":740,"y":273},{"x":731,"y":269},{"x":723,"y":279},{"x":709,"y":276},{"x":702,"y":289},{"x":687.25,"y":292},{"x":670,"y":285},{"x":659,"y":269.375},{"x":652,"y":238}],"name":"bicycle","color":"#008000"},{"points":[{"x":357,"y":244.605},{"x":378,"y":238},{"x":387,"y":236},{"x":398.75,"y":236},{"x":459,"y":256},{"x":483,"y":278},{"x":504,"y":285.875},{"x":515,"y":332.395},{"x":479,"y":330},{"x":430,"y":306},{"x":404.25,"y":344},{"x":401,"y":341.125},{"x":423,"y":302},{"x":403,"y":289},{"x":375,"y":268}],"name":"umbrella","color":"#008000"},{"points":[{"x":894.06,"y":82},{"x":886,"y":71},{"x":873.5,"y":73},{"x":867,"y":85},{"x":872,"y":99},{"x":868,"y":117.75},{"x":861,"y":128},{"x":840,"y":124},{"x":850,"y":138},{"x":865,"y":148},{"x":869,"y":176},{"x":860,"y":190},{"x":869,"y":191},{"x":879.94,"y":189},{"x":891,"y":182},{"x":886,"y":172},{"x":883.5,"y":153},{"x":903,"y":160.25},{"x":914,"y":145},{"x":913,"y":122},{"x":906,"y":104},{"x":893,"y":94}],"name":"person","color":"#1000f0"},{"points":[{"x":868.62,"y":112},{"x":854,"y":86},{"x":851,"y":76},{"x":841,"y":68},{"x":829,"y":75},{"x":825.5,"y":83},{"x":829,"y":100},{"x":825,"y":109},{"x":815,"y":123},{"x":803,"y":130.125},{"x":812,"y":137},{"x":812,"y":151},{"x":810,"y":163},{"x":795,"y":171},{"x":798.38,"y":180},{"x":818,"y":173},{"x":819,"y":181},{"x":835.5,"y":177},{"x":842,"y":154.875},{"x":842,"y":137},{"x":864,"y":122}],"name":"person","color":"#1000f0"},{"points":[{"x":383.165,"y":83},{"x":364,"y":75},{"x":358.125,"y":60},{"x":333,"y":79.875},{"x":347,"y":93},{"x":340,"y":105},{"x":339,"y":121},{"x":329,"y":128},{"x":332,"y":141},{"x":342,"y":156},{"x":342.835,"y":196},{"x":358,"y":243},{"x":376,"y":239},{"x":377,"y":209},{"x":388.875,"y":238},{"x":410,"y":237.125},{"x":395,"y":181},{"x":407,"y":137},{"x":397,"y":93}],"name":"person","color":"#1000f0"},{"points":[{"x":167.17,"y":79},{"x":191.25,"y":78},{"x":188,"y":97},{"x":195,"y":108.625},{"x":198,"y":137},{"x":212,"y":168},{"x":206.83,"y":176},{"x":173.75,"y":169},{"x":164,"y":157},{"x":155,"y":160},{"x":149,"y":136.375},{"x":150,"y":103},{"x":166,"y":93}],"name":"person","color":"#1000f0"},{"points":[{"x":899,"y":259.76},{"x":927,"y":255},{"x":954,"y":263},{"x":943,"y":224},{"x":991,"y":228},{"x":985,"y":278},{"x":1005,"y":278},{"x":1024,"y":281},{"x":1024,"y":343.24},{"x":998,"y":358},{"x":989,"y":378},{"x":975,"y":379},{"x":971,"y":389},{"x":968,"y":410},{"x":955,"y":413},{"x":935,"y":386},{"x":905,"y":377},{"x":883,"y":348},{"x":878,"y":312}],"name":"bicycle","color":"#008000"},{"points":[{"x":907,"y":209.715},{"x":932.25,"y":207},{"x":955,"y":213.125},{"x":948,"y":232},{"x":952,"y":256.285},{"x":910.75,"y":255},{"x":893,"y":245.875},{"x":894,"y":226}],"name":"food basket","color":"#008000"},{"points":[{"x":67.83500000000001,"y":225},{"x":87,"y":212},{"x":116,"y":217},{"x":109,"y":250},{"x":121,"y":247},{"x":133,"y":231},{"x":153,"y":231},{"x":180,"y":240},{"x":154,"y":268},{"x":193,"y":257},{"x":211,"y":244},{"x":228.875,"y":236},{"x":230,"y":250},{"x":191,"y":278},{"x":242,"y":338},{"x":240,"y":368},{"x":202,"y":402},{"x":295,"y":367},{"x":299,"y":372.375},{"x":285,"y":391},{"x":248,"y":409},{"x":217,"y":417},{"x":239,"y":447},{"x":271,"y":500},{"x":334.165,"y":661},{"x":216.125,"y":663},{"x":189,"y":613},{"x":167,"y":558},{"x":155,"y":501},{"x":144,"y":455},{"x":118,"y":476},{"x":114,"y":465},{"x":88,"y":474.625},{"x":86,"y":464},{"x":131,"y":438},{"x":130,"y":416},{"x":119,"y":400},{"x":76,"y":407},{"x":74,"y":401},{"x":34,"y":408},{"x":29,"y":392},{"x":84,"y":389},{"x":115,"y":376},{"x":110,"y":359},{"x":92,"y":313},{"x":45,"y":320},{"x":42,"y":306},{"x":75,"y":292},{"x":67,"y":270},{"x":73,"y":250}],"name":"parked bicycles","color":"#008000"}]}
];

g_polys=example1Labels;
repaint();

</script>
</body>
</html>

